# 自定义算子代码编写

自定义算子代码编写是算子开发使用中最重要的步骤，它的主要目的是为了实现算子的逻辑处理步骤，此处需要开发人员根据待开发功能的处理逻辑和平台算子开发规范进行代码编写，下图为平台自定义算子逻辑开发的流程。

![PNG](../../img/2.png)

自定义算子主要是通过定义端口来接收数据，然后在其中定义算子的逻辑处理步骤对数据进行逻辑处理，然后将结果通过输出端口传出。同时，通过参数定义可以预留了一些参数接口给用户进行调试。下图为自定义算子代码编写示例：

![PNG](../../img/3.png)

由上图可以清晰的看到自定义算子代码编写的三个部分。

**定义算子数据输入输出端口（无需数据输入或输出可相应省略）**

其中输入端口需规定算子接收什么类型的数据（模型或数据）、端口名称、端口描述；输出端口需规定算子输出什么类型的数据（数据、模型、视图）、端口名称、端口描述。所有的这些定义，最终都会在前端得到展示，例如将算子拖拽至画布中后，算子的左边是输入端口,右边为输出端口，DATA表示输入（输出）数据，MODEL表示输入（输出）模型，鼠标移动至端口上时，会显示端口名称。图2-3的例子中，是要完成两个表的join操作，这里定义了两个输入端口和一个输出端口，均为数据类型（PortType.DATA，若需要定义模型端口，后面的端口类型就是PortType.MODEL，同理，若是视图，则为PortType.VIEW）

**定义算子的接收参数（无需参数可省略此步骤）**

此处需要定义暴露给用户调试算子参数的入口，若参数是数值类型的，需定义参数的名称、描述、取值范围、默认值（可省略）；若参数是字符类型的，需定义参数的名称、描述、可选值（可省略）、默认值（可省略）。除此之外，还可以规定参数在什么情况下生效，例如，只有当A参数为某特定值时，B参数才生效，此时在定义B参数的代码中加上condition= Some(A in 特定值)即可。定义好的这些参数，在生成算子之后，双击算子就可以看到这些参数的编辑面板。图2-3的例子中，定义了一个joinKeys参数，它依赖输入的列名选择。

**算子的逻辑处理开发（根据具体业务）**

此处规定了数据从输入到输出的处理步骤，是算子的核心部分，若有输出，需要通过输出端口的diliver方法，将数据传出。图2-3的例子中，首先通过输入端口的getData方法，将传入的数据取出，然后对其进行join操作（调用spark dataframe里的方法），join的关键字为传入的joinKeys参数，通过buildJoinKeys方法获取（自己编写，里面只包含一句代码joinKey.value）。最终将生成的新表通过输出端口的diliver方法传出。值得说明的是，传出的数据必须转换成DataFrameObject类型，里面除了spark的dataframe之外，还包含一个meta信息（用于存储特征的role）；如果传出的是Model，需要使其继承ICUModel类。
